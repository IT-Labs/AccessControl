˛O
@c:\D\PROJECTS\AccessControl\Communication\Sockets\AsyncClient.cs
	namespace 	
Communication
 
. 
Sockets 
{ 
public		 

	interface		 
IAsyncClient		 !
{

 
Task 
< 
byte 
[ 
] 
> 
StartClient  
(  !
string! '
ip( *
,* +
int, /
port0 4
,4 5
byte6 :
[: ;
]; <
msg= @
)@ A
;A B
} 
public 

class 
AsyncClient 
: 
IAsyncClient +
{ 
private 
readonly 
ManualResetEvent )
connectDone* 5
=6 7
new8 ;
ManualResetEvent< L
(L M
falseM R
)R S
;S T
private 
readonly 
ManualResetEvent )
sendDone* 2
=3 4
new5 8
ManualResetEvent9 I
(I J
falseJ O
)O P
;P Q
private 
readonly 
ManualResetEvent )
receiveDone* 5
=6 7
new8 ;
ManualResetEvent< L
(L M
falseM R
)R S
;S T
private 
byte 
[ 
] 
response 
=  !
new" %
byte& *
[* +
$num+ ,
], -
;- .
public 
async 
Task 
< 
byte 
[ 
]  
>  !
StartClient" -
(- .
string. 4
ip5 7
,7 8
int9 <
port= A
,A B
byteC G
[G H
]H I
msgJ M
)M N
{ 	
	IPAddress 
	ipAddress 
=  !
	IPAddress" +
.+ ,
Parse, 1
(1 2
ip2 4
)4 5
;5 6

IPEndPoint 
remoteEP 
=  !
new" %

IPEndPoint& 0
(0 1
	ipAddress1 :
,: ;
port< @
)@ A
;A B
Socket!! 
client!! 
=!! 
new!! 
Socket!!  &
(!!& '
	ipAddress!!' 0
.!!0 1
AddressFamily!!1 >
,!!> ?

SocketType!!@ J
.!!J K
Stream!!K Q
,!!Q R
ProtocolType!!S _
.!!_ `
Tcp!!` c
)!!c d
;!!d e
client$$ 
.$$ 
BeginConnect$$ 
($$  
remoteEP$$  (
,$$( )
new$$* -
AsyncCallback$$. ;
($$; <
ConnectCallback$$< K
)$$K L
,$$L M
client$$N T
)$$T U
;$$U V
if&& 
(&& 
!&& 
connectDone&& 
.&& 
WaitOne&& $
(&&$ %
TimeSpan&&% -
.&&- .
FromSeconds&&. 9
(&&9 :
$num&&: <
)&&< =
)&&= >
)&&> ?
{'' 
Console(( 
.(( 
ForegroundColor(( '
=((( )
ConsoleColor((* 6
.((6 7
Red((7 :
;((: ;
Console)) 
.)) 
	WriteLine)) !
())! "
$str))" 8
)))8 9
;))9 :
Console** 
.** 

ResetColor** "
(**" #
)**# $
;**$ %
}++ 
Send.. 
(.. 
client.. 
,.. 
msg.. 
).. 
;.. 
if// 
(// 
!// 
sendDone// 
.// 
WaitOne// !
(//! "
TimeSpan//" *
.//* +
FromSeconds//+ 6
(//6 7
$num//7 9
)//9 :
)//: ;
)//; <
{00 
Console11 
.11 
ForegroundColor11 '
=11( )
ConsoleColor11* 6
.116 7
Red117 :
;11: ;
Console22 
.22 
	WriteLine22 !
(22! "
$str22" 5
)225 6
;226 7
Console33 
.33 

ResetColor33 "
(33" #
)33# $
;33$ %
}44 
Receive77 
(77 
client77 
)77 
;77 
if99 
(99 
!99 
receiveDone99 
.99 
WaitOne99 $
(99$ %
TimeSpan99% -
.99- .
FromSeconds99. 9
(999 :
$num99: <
)99< =
)99= >
)99> ?
{:: 
Console;; 
.;; 
ForegroundColor;; '
=;;( )
ConsoleColor;;* 6
.;;6 7
Red;;7 :
;;;: ;
Console<< 
.<< 
	WriteLine<< !
(<<! "
$str<<" 7
)<<7 8
;<<8 9
Console== 
.== 

ResetColor== "
(==" #
)==# $
;==$ %
}>> 
clientAA 
.AA 
ShutdownAA 
(AA 
SocketShutdownAA *
.AA* +
BothAA+ /
)AA/ 0
;AA0 1
clientBB 
.BB 
CloseBB 
(BB 
)BB 
;BB 
awaitDD 
TaskDD 
.DD 
YieldDD 
(DD 
)DD 
;DD 
returnEE 
responseEE 
;EE 
}FF 	
privateHH 
voidHH 
ConnectCallbackHH $
(HH$ %
IAsyncResultHH% 1
arHH2 4
)HH4 5
{II 	
SocketKK 
clientKK 
=KK 
(KK 
SocketKK #
)KK# $
arKK$ &
.KK& '

AsyncStateKK' 1
;KK1 2
clientNN 
.NN 

EndConnectNN 
(NN 
arNN  
)NN  !
;NN! "
ConsolePP 
.PP 
	WriteLinePP 
(PP 
$strPP 7
,PP7 8
clientPP9 ?
.PP? @
RemoteEndPointPP@ N
.PPN O
ToStringPPO W
(PPW X
)PPX Y
)PPY Z
;PPZ [
connectDoneSS 
.SS 
SetSS 
(SS 
)SS 
;SS 
}TT 	
privateVV 
voidVV 
ReceiveVV 
(VV 
SocketVV #
clientVV$ *
)VV* +
{WW 	
StateObjectYY 
stateYY 
=YY 
newYY  #
StateObjectYY$ /
(YY/ 0
)YY0 1
;YY1 2
stateZZ 
.ZZ 

workSocketZZ 
=ZZ 
clientZZ %
;ZZ% &
client]] 
.]] 
BeginReceive]] 
(]]  
state]]  %
.]]% &
buffer]]& ,
,]], -
$num]]. /
,]]/ 0
StateObject]]1 <
.]]< =

bufferSize]]= G
,]]G H
$num]]I J
,]]J K
new]]L O
AsyncCallback]]P ]
(]]] ^
ReceiveCallback]]^ m
)]]m n
,]]n o
state]]p u
)]]u v
;]]v w
}^^ 	
private`` 
void`` 
ReceiveCallback`` $
(``$ %
IAsyncResult``% 1
ar``2 4
)``4 5
{aa 	
StateObjectcc 
statecc 
=cc 
(cc  !
StateObjectcc! ,
)cc, -
arcc- /
.cc/ 0

AsyncStatecc0 :
;cc: ;
Socketdd 
clientdd 
=dd 
statedd !
.dd! "

workSocketdd" ,
;dd, -
intgg 
	bytesReadgg 
=gg 
clientgg "
.gg" #

EndReceivegg# -
(gg- .
argg. 0
)gg0 1
;gg1 2
Consolejj 
.jj 
	WriteLinejj 
(jj 
$strjj 1
,jj1 2
	bytesReadjj3 <
)jj< =
;jj= >
Arraymm 
.mm 
Resizemm 
(mm 
refmm 
responsemm %
,mm% &
	bytesReadmm' 0
)mm0 1
;mm1 2
Arraypp 
.pp 
Copypp 
(pp 
statepp 
.pp 
bufferpp #
,pp# $
$numpp% &
,pp& '
responsepp( 0
,pp0 1
$numpp2 3
,pp3 4
	bytesReadpp5 >
)pp> ?
;pp? @
receiveDonerr 
.rr 
Setrr 
(rr 
)rr 
;rr 
}ss 	
privateuu 
voiduu 
Senduu 
(uu 
Socketuu  
clientuu! '
,uu' (
byteuu) -
[uu- .
]uu. /
byteDatauu0 8
)uu8 9
{vv 	
clientxx 
.xx 
	BeginSendxx 
(xx 
byteDataxx %
,xx% &
$numxx' (
,xx( )
byteDataxx* 2
.xx2 3
Lengthxx3 9
,xx9 :
$numxx; <
,xx< =
newxx> A
AsyncCallbackxxB O
(xxO P
SendCallbackxxP \
)xx\ ]
,xx] ^
clientxx_ e
)xxe f
;xxf g
}yy 	
private{{ 
void{{ 
SendCallback{{ !
({{! "
IAsyncResult{{" .
ar{{/ 1
){{1 2
{|| 	
Socket~~ 
client~~ 
=~~ 
(~~ 
Socket~~ #
)~~# $
ar~~$ &
.~~& '

AsyncState~~' 1
;~~1 2
int
ÅÅ 
	bytesSent
ÅÅ 
=
ÅÅ 
client
ÅÅ "
.
ÅÅ" #
EndSend
ÅÅ# *
(
ÅÅ* +
ar
ÅÅ+ -
)
ÅÅ- .
;
ÅÅ. /
Console
ÇÇ 
.
ÇÇ 
	WriteLine
ÇÇ 
(
ÇÇ 
$str
ÇÇ 9
,
ÇÇ9 :
	bytesSent
ÇÇ; D
)
ÇÇD E
;
ÇÇE F
sendDone
ÖÖ 
.
ÖÖ 
Set
ÖÖ 
(
ÖÖ 
)
ÖÖ 
;
ÖÖ 
}
ÜÜ 	
}
áá 
}àà Œ
Ac:\D\PROJECTS\AccessControl\Communication\Sockets\StateObjects.cs
	namespace 	
Communication
 
. 
Sockets 
{ 
public 

class 
StateObject 
{ 
public 
Socket 

workSocket  
=! "
null# '
;' (
public 
const 
int 

bufferSize #
=$ %
$num& )
;) *
public 
byte 
[ 
] 
buffer 
= 
new "
byte# '
[' (

bufferSize( 2
]2 3
;3 4
} 
} 